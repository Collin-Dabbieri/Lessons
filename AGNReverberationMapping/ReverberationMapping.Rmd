---
title: "AGN Reverberation Mapping"
author: "Collin Dabbieri"
date: "12/9/2019"
output: 
  html_document:
    toc: yes
    toc_float: yes


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```





# Background Info

Quasars are the most luminous objects in the universe. They're so bright that we can observe light from quasars that was emitted over 10 billion years ago. Quasars form when a supermassive black hole at the center of a galaxy draws gas from its host forming a disk that accretes onto the black hole. This disk emits thermal radiation that outshines the entire host galaxy. A diagram is given below.

![Quasar Diagram](./agn_model.gif){width=300, height=400px}

The continuum light from the accretion disk emits like the sum of many blackbodies at different temperatures, and in practice is modelled as a power-law. The broad line region is illuminated by the accretion disk and gives off broad emission lines. An example synthetic spectrum is given below.

![Quasar Spectrum](./Emission_Spectrum.png){width=300, height=400px}


# Galaxy Feedback

There's a well-known correlation between the mass of a galaxy's spheroidal component and the mass of the supermassive black hole at its center. For an elliptical galaxy, the spheroid is the whole galaxy, and for a spiral galaxy the spheroid is the central bulge. A plot illustrating this correlation is given below

![Gultekin et al. 2009 ApJ 698 198](./msigma.png){width=300, height=400px}


This is known as the M-$\sigma$ relation. The x-axis is the host galaxy's velocity dispersion, an analogue for its mass. The y-axis is the mass of the supermassive black hole at the center of the host galaxy. This correlation implies some coevolution mechanism between the supermassive black hole and its host galaxy. The source of this mechanism is an important area of active research.

# Reverberation Mapping

One of the ways we can constrain the mass of the supermassive black hole is through AGN reverberation mapping. Because gas in the broad line region orbits the black hole with keplerian velocities, we can use properties of the broad line region to constrain the black hole mass. To achieve this we need to calculate two things, a characteristic radius of the broad line region, and the velocity dispersion of the gas at that radius. If we can constrain these two values, our supermassive black hole mass can be given by the following equation.

$$M_{BH}=f\frac{Rv^2}{G}$$

Where R is the radius of the broad line region and $v$ is the characteristic velocity. $f$ is a parameter that takes in to account things like the inclination of the accretion disc and the geometry of the broad line region. In practice, we are usually not able to constrain these values for an individual quasar, for reasons we'll discuss below, and so average $f$ values are determined. $<f>$ can actually be calculated from the M-$\sigma$ relation above. Reverberation mapping is not the only way to constrain the mass of a supermassive black hole, so we can use the line of best fit for M-$\sigma$ values determined through other means to constrain our $<f>$ for reverberation mapped objects. The next few sections will discuss how we determine the radius and velocity of the broad line region.

## Constraining the Radius

The broad line region contains clouds of gas orbiting the supermassive black hole with Keplerian velocities. This gas is illuminated by the continuum from the accretion disk and manifests itself through emission lines in quasar spectra.

Quasars have been observed to have significant variability in their continua. Because the broad line region is illuminated by the continuum source, variability in the continuum will cause variability in the emission lines. However, the variability in the emission lines will lag behind the variability in the continuum source, as it takes light time to travel from the accretion disk to the broad line region. By probing the time lag between the variability in the continuum and the variability in the emission lines, we can derive an estimate for the distance from the accretion disk to the broad line region.

The time delay of the variability ($\tau$) is equal to the average distance (R) divided by the speed of light (c)

$$\tau=\frac{R}{c}$$

In practice we can determine $\tau$ by gathering light curves for the continuum and some emission line and estimating the lag using cross correlation (more on that later).

While we consider the accretion disk to be small enough to ignore variations in the location of the continuum, the same can not be said for the broad line region. I.e we can not treat the broad line region as a single point. In fact, we observe ionization stratification in the broad line region. That is, emission lines with higher ionization potentials will probe radii closer to the accretion disk. The broad line region is more ionized closer to the accretion disk.

![Reverberation Mapping Diagram](./ReverberationMapping.png){width=400,height=400px}


### Transfer Function

When we pick out some emission line, like $H\beta$ and use that, along with the continuum, to measure $\tau$, we are measuring the $H\beta$ emission weighted average light travel time. Continuum light travels straight to the observer. The emission light will always take longer to reach the observer than the continuum light, but, depending on where it interacts with the broad line region, it can take any amount of time longer to reach the observer.


![Emission Lag](./TransferFunction.png){width=300,height=300px}

We can see how there needs to be some term that gives us information about the geometry of the broad line region, otherwise we would have no idea what radius we were probing. We call this term the transfer function, $\Psi(\tau)$, and it's defined such that the emission light curve, L(t), is the convolution of the transfer function and the continuum light curve, C(t)

$$L(t)=\int_{-\infty}^{\infty}\Psi(\tau)C(t-\tau)d\tau$$


We can think of this as the weighted average of the continuum light curve given the geometry of the broad line region. More exactly, the transfer function represents the broad line region's response to a $\delta$ function outburst, as observed from far away. Ideally, the measurement of L(t) and C(t) would allow us to gain some information about the geometry of the broad line region. However, there are many reasons why this ends up being quite difficult (ex. White and Peterson 1994).

In practice the transfer function is often ignored, and it is accepted that black hole masses may be uncertain to a factor of ~ 2. Even considering the transfer function, you would still see a lag value of $\tau=\frac{R}{c}$ for both a thin spherical shell of radius R and a thin ring of radius R at any inclination! (White and Peterson 1994).


### Finding the Lag

In order to compute the lag time, we use the cross correlation function. Cross correlation gives a measure of the similarity of two series as a function of the displacement of one relative to the other.

$$F_{CCF}(\tau)=\int_{-\infty}^{\infty}L(t)C(t-\tau)dt$$

Let's examine the CCF for sin(x) and cos(x)

![](./singif_screenshots/sinplots.gif){width=300,height=300px}

NOTE: I've embedded a gif here because there's some weirdness with sending interactive servers. I.e you wouldn't be able to run the server on your machine without having the r scripts in the same directory and having shiny installed. I can resolve this for the class by hosting the server on shinyapps.io 

```{r,echo=FALSE, eval=FALSE}
library(shiny)

shinyAppFile("sincos_shinyapp.R")

```

The cross correlation function reaches its maximum at a delay of $3\pi/2$, when the two functions are identical. Similarly, we can plot our continuum and emission light curves with a delay and find the lag time with the maximum cross correlation function value.


However, we have light curves sampled at discrete times, so we need a discrete version of this cross correlation function.

$$F_{CCF}(\tau)=\frac{1}{N}\sum_{i=i}^N\frac{[L(t_i)-\bar L][C(t_i-\tau)-\bar C]}{\sigma_C \sigma_L}$$

This method assumes evenly sampled time data, which is nearly impossible to achieve, so we can interpolate our light curves onto evenly sampled time intervals. 

```{r,echo=FALSE, eval=FALSE}
library(shiny)

shinyAppFile("lagplot_shinyapp.R")

```

Once we've used the cross correlation function to pick out our ideal lag time, we can determine the radius of the broad line region with 

$$R=\tau c$$

### Real Data


Let's look at some continuum and emission light curves. This data was reported in Grier et al 2012 ApJ 755 60.


```{r}
Continuum=read.table("Mrk335_Continuum.txt")
colnames(Continuum)=c("HJD","Flux")
head(Continuum)
```


```{r}
Emission=read.table("Mrk335_Emission.txt")
colnames(Emission)=c("HJD","FHb")
head(Emission)
```

We'll want to normalize the flux values so they can be properly compared.


```{r}
normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
  }
```



```{r}
library(ggplot2)
ggplot()+
  geom_line(aes(HJD,normalize(Flux)),data=Continuum)+
  geom_line(aes(HJD,normalize(FHb)),data=Emission)
```


Now we can interpolate onto evenly sampled time bins

```{r}
xout=seq(min(Emission$HJD),max(Emission$HJD),length.out=length(Emission$HJD)) #pick evenly sampled x values

temp=approx(Emission$HJD,Emission$FHb,xout) #interpolate emission light curve onto those values
temp=temp$y
FHb_interp=normalize(temp)

temp=approx(Continuum$HJD,Continuum$Flux,xout) #interpolate continuum light curve onto those values
temp=temp$y
Fc_interp=normalize(temp)

ggplot()+
  geom_line(aes(xout,Fc_interp))+
  geom_line(aes(xout,FHb_interp))
```


Now let's make a method for calculating the discrete cross correlation function

$$F_{CCF}(\tau)=\frac{1}{N}\sum_{i=i}^N\frac{[L(t_i)-\bar L][C(t_i-\tau)-\bar C]}{\sigma_C \sigma_L}$$


```{r}

CCF<-function(C,L,x,lagmax){
  
  num_lags=lagmax #moving in intervals of 1
  N=length(C)

  sigmaC=sd(C)
  sigmaL=sd(L)
  Cbar=mean(C)
  Lbar=mean(L)
  
  ccf_out=c()
  lags=c()
  

  for(tau in 1:lagmax){
    
    
    count=0 #for normalization
    sum=0

    for(i in (tau+1):N){ #we have to cut off early values so C(t_i-tau) makes sense
      
      count=count+1

      val=(L[i]-Lbar)*(C[i-tau]-Cbar)/(sigmaC*sigmaL) #discrete ccf for one i value

      sum=sum+val
    }
    

    ccf_out=append(ccf_out,sum/count)
    lags=append(lags,x[tau]-x[1])
  
  }

  
  return(list(lags=lags,CCF=ccf_out))
  
}


```

We can test this function on our sin and cos plot

```{r}
x=seq(-2*pi,2*pi,length.out=50)
obj=CCF(sin(x),cos(x),x,40)

plot(obj$lags,obj$CCF)
```

Again we see a peak at $3\pi/2$.

Now let's apply it to our light curves

```{r}
obj=CCF(Fc_interp,FHb_interp,xout,30)
plot(obj$lags,obj$CCF,xlab='lag (days)',ylab='CCF')
lines(c(15.5,15.5),c(0,1))
```


Let's plot our continuum and emission light curves with variable lag value, along with the CCF



![](./laggif_screenshots/lagplots.gif){width=300,height=300px}


```{r,echo=FALSE, eval=FALSE}
library(shiny)

shinyAppFile("lagplot_shinyapp.R")

```


Our final broad line region radius for this data is roughly 15 light days. This is pretty consistent with the values reported in Grier et al 2012 for Mrk 335. 

## Constraining the Velocity

We determine the velocity dispersion of the broad line region by fitting a single-epoch emission line for its velocity width. It's important to remember that we must use the same emission line that we used to constrain the radius, so we're probing the same region of the gas in the broad line region. Often these values are measured with the H$\beta$ emission line.


# Black Hole Masses

The AGN black hole mass database has compiled all published spectroscopic reverberation mapping studies of active galaxies


```{r}
mbh=read.csv("MBH_edit.csv",sep=",",header=F)
colnames(mbh)=c("Name","RA","Dec","redshift","logMBH","+elogMBH","-elogMBH")
head(mbh)
```


```{r}
hist(mbh$logMBH)
```

# Template shiny application

Use this template to develop your own interactive applications

```{r,eval=FALSE}
library(shiny)

shinyApp(

  ui <- fluidPage(
    
    # App title 
    titlePanel("Template"),
    
    #Sidebar layout with input and output
    sidebarLayout(
      
      #sidebar panel for inputs
      sidebarPanel(
        
        #Input: Slider for tau
        sliderInput(inputId="tau",
                    label="lag:",
                    min=0,
                    max=6.28,
                    value=0)),
      
      #Main panel for displaying outputs
      mainPanel(
        plotOutput("sinPlot")
  
      )
      
      
    )
    
  ),
  
  ## Server
  
  # Define a server function for the Shiny app
  
  server <- function(input,output){
    
    output$sinPlot <- renderPlot({
      #plotting sin(x-tau)
      
      x=seq(-2*pi,2*pi,length.out=50)
      y1=sin(x-input$tau)

      
      ggplot()+
        geom_line(aes(x,y1),colour='red')

  
    })
    

      
      
    }
)

```

![](./templategif_screenshots/template.gif){width=300,height=300px}


# Conclusions



## Questions to Ponder

Consider using this notebook as a means of answering these questions for yourself.

1. Would we be able to perform our analysis for a quasar that was 100 times brighter? How long might the lag be?

2. 

...





